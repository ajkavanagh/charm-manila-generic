# Note that the original manila.conf file is extensive and has many options
# that the charm does not set.  Please refer to that file if there are options
# that you think the charm should set, but doesn't, or provide options for.
# Please file a bug at: https://bugs.launchpad.net/charm-barbican/+filebug for
# any changes you need made or intend to modify in the charm.

[DEFAULT]

# This all needs to be configurable
enabled_share_backends = {{ options.computed_share_backends }}

# enabled_share_protocols = NFS,CIFS
enabled_share_protocols = {{ options.computed_share_protocols }}

#default_share_type = default_share_type
default_share_type = {{ options.default_share_type }}

state_path = /var/local/manila
osapi_share_extension = manila.api.contrib.standard_extenstions
rootwrap_config = /etc/manila/rootwrap.conf
api_paste_config = /etc/manila/api-paste.ini
share_name_template = share-%s

scheduler_driver = manila.scheduler.drivers.filter.FilterScheduler

debug = {{ options.debug }}


[cors]

#
# From oslo.middleware.cors
#

[cors.subdomain]

#
# From oslo.middleware.cors
#

# parts/section-database includes the [database] section identifier
{% include "parts/section-database" %}


# parts/section-keystone-authtoken includes the [keystone_authtoken] section
# identifier
{% include "parts/section-keystone-authtoken" %}



[matchmaker_redis]

#
# From oslo.messaging
#

[oslo_messaging_amqp]

#
# From oslo.messaging
#

[oslo_messaging_notifications]

#
# From oslo.messaging
#


# parts/section-rabbitmq-olso include the [oslo_messaging_rabbit] section
# identifier
{% include "parts/section-rabbitmq-oslo" %}


#
# Configuration writen if the generic driver is requested.
#

{% if options.computed_generic_driver %}
[nova]
# Only needed for the generic drivers as of Mitaka
# We use the generic manila username/password as it's part of the service
# domain
username = {{ identity_service.service_username }}
password = {{ identity_service.service_password }}
project_domain_id = default
project_name = services
user_domain_id = default
auth_uri = {{ identity_service.service_protocol }}://{{ identity_service.service_host }}:{{ identity_service.service_port }}
auth_url = {{ identity_service.auth_protocol }}://{{ identity_service.auth_host }}:{{ identity_service.auth_port }}
auth_type = password

[neutron]
# Only needed for the generic drivers as of Mitaka
username = {{ identity_service.service_username }}
password = {{ identity_service.service_password }}
project_domain_id = default
project_name = services
user_domain_id = default
auth_uri = {{ identity_service.service_protocol }}://{{ identity_service.service_host }}:{{ identity_service.service_port }}
auth_url = {{ identity_service.auth_protocol }}://{{ identity_service.auth_host }}:{{ identity_service.auth_port }}
auth_type = password

[cinder]
# Only needed for the generic drivers as of Mitaka
username = {{ identity_service.service_username }}
password = {{ identity_service.service_password }}
project_domain_id = default
project_name = services
user_domain_id = default
auth_uri = {{ identity_service.service_protocol }}://{{ identity_service.service_host }}:{{ identity_service.service_port }}
auth_url = {{ identity_service.auth_protocol }}://{{ identity_service.auth_host }}:{{ identity_service.auth_port }}
auth_type = password


# Also needs to be generated by the configuration
[generic]
# This is custom opt group that is used for storing opts of share-service.
# This one is used only when enabled using opt `enabled_share_backends`
# from DEFAULT group.

# Set usage of Generic driver which uses cinder as backend.
share_driver = manila.share.drivers.generic.GenericShareDriver

# Generic driver supports both driver modes - with and without handling
# of share servers. So, we need to define explicitly which one we are
# enabling using this driver.
driver_handles_share_servers = {{ options.generic_driver_handles_share_servers }}

# The flavor that Manila will use to launch the instance.
service_instance_flavor_id = {{ options.generic_driver_service_instance_flavor_id }}

# Generic driver uses a glance image for building service VMs in nova.
# The following options specify the image to use.
# We use the latest build of [1].
# [1] https://github.com/openstack/manila-image-elements
service_instance_user = {{ options.generic_driver_service_instance_user }}
service_image_name = {{ options.generic_driver_service_image_name }}

connect_share_server_to_tenant_network = {{ options.generic_driver_connect_share_server_to_tenant_network }}

# These will be used for keypair creation and inserted into service VMs.
# TODO: this presents a problem with HA and failover - as the keys will no
# longer be the same -- need to be able to set these via a config option.
{% if options.computed_generic_use_password %}
service_instance_password = {{ options.generic_driver_service_instance_password }}
{% endif -%}
{% if options.computed_generic_use_ssh %}
path_to_private_key = /etc/ssh/ssh_host_rsa_key
path_to_public_key = /etc/ssh/ssh_host_rsa_key.pub
manila_service_keypair_name = {{ options.generic_driver_keypair_name }}
{%- endif %}

# Custom name for share backend.
share_backend_name = generic

# end of generic if
{%- endif %}
